---
- hosts: all
  tasks:

  - name: Register system to satellite and repos
    include_role:
      name: register-system
    tags:
      - register


  - name: Install postgresql 95
    yum:
      name:
        - rh-postgresql95
        - rh-postgresql95-postgresql-contrib
      state: latest
    tags:
      - install-postgres

  - name: Install Docker
    yum:
      name: docker 
      state: latest
    tags:
      - install-docker

  - name: Start and enable docker 
    systemd:
      name: docker 
      state: started
      enabled: yes
    tags:
      - start-docker

  - name: Enable firewalld ports for postgresql 
    firewalld:
      port: "{{ item }}"
      permanent: yes
      state: enabled
      zone: public
    with_items:
      - 8443/tcp
      - 80/tcp
      - 443/tcp
    notify:
      - reload-firewall
    tags:
      - firewalld

  - name: Create env file on target
    template:
      src: mysql-env-file
      dest: ~/mysql-env-file
    tags:
      - deploy-mysql-container
      - deploy-mysql-env-file

 # - name: Total garbage method of deploying mysql container
 #   command: "docker run \
 #   --detach \
 #   --restart=always \
 #   --env MYSQL_ROOT_PASSWORD={{ MYSQL_ROOT_PASSWORD }} \
 #   --env MYSQL_USER={{ MYSQL_USER }} \
 #   --env MYSQL_PASSWORD={{ MYSQL_PASSWORD }} \
 #   --env MYSQL_DATABASE={{ MYSQL_DATABASE }} \
 #   --name {{ MYSQL_CONTAINER_NAME }} \
 #   --privileged=true \
 #   --publish 3306:3306 \
 #   -v /var/lib/mysql:/var/lib/mysql/data:Z \
 #   registry.access.redhat.com/rhscl/mysql-57-rhel7"
 #   tags:
 #     - deploy-mysql-container

  - name: Create /var/lib/mysql
    file:
      path: /var/lib/mysql
      state: directory
      mode: '0777'
    tags:
      - deploy-mysql-container
    
  - name: Install python-docker-py and mysql-python on target
    yum:
      name: 
        - python-docker-py
        - MySQL-python
      state: latest
    tags:
      - deploy-mysql-container

  - name: Total garbage method of deploying mysql container
    docker_container:
      env_file: "~/mysql-env-file"
      detach: yes
      restart: yes
      name: "{{ MYSQL_CONTAINER_NAME }}"
      privileged: yes
      published_ports: 3306:3306
      volumes: /var/lib/mysql:/var/lib/mysql/data:Z
      image: "registry.access.redhat.com/rhscl/mysql-57-rhel7"
    tags:
      - deploy-mysql-container

  - name: Ensure that the mysql container is running and quay db exists
    mysql_db:
      name: "{{ MYSQL_DATABASE }}"
      state: present
      login_host: 127.0.0.1
      login_user: root
      login_password: "{{ MYSQL_ROOT_PASSWORD }}"
    tags:
      - deploy-mysql-container
      - test-mysql-db

##### mkdir /var/lib/redis
  - name: Create /var/lib/redis
    file:
      path: /var/lib/redis
      state: directory
      mode: '0777'
    tags:
      - deploy-redis-container



  handlers:

  - name: reload-firewall
    command: firewall-cmd --reload


  
