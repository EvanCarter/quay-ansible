---
- hosts: all

  handlers:
    - name: Include all handlers
      import_tasks: handlers/main.yml

  tasks:

  - name: Register system to satellite and repos
    include_role:
      name: register-system
    tags:
      - register

- hosts: database
  handlers:
    - name: Include all handlers
      import_tasks: handlers/main.yml

  tasks:
  - name: Deploy docker to database container host
    include_tasks: tasks/setup-docker.yml
    vars:
      docker_packages:
        - docker
        - python-docker-py
        - MySQL-python
    when: QUAY_DATABASE_CONTAINERIZE

  - name: Configure firewall
    include_tasks: tasks/firewall-setup.yml
    vars:
      ports:
        - 3306/tcp
      when: QUAY_MYSQL_DEPLOY

  - name: Deploy conatinerized mysql
    include_tasks: tasks/mysql-setup.yml
    when: QUAY_MYSQL_DEPLOY and QUAY_DATABASE_CONTAINERIZE

- hosts: redis
  handlers:
    - name: Include all handlers
      import_tasks: handlers/main.yml

  tasks:
  - name: Deploy docker to redis container host
    include_tasks: tasks/setup-docker.yml
    vars:
      docker_packages:
        - docker
        - python-docker-py
    when: QUAY_REDIS_CONTAINERIZE

  - name: Configure firewall
    include_tasks: tasks/firewall-setup.yml
    vars:
      ports:
        - 6379/tcp
      when: QUAY_MYSQL_DEPLOY

  - name: Deploy redis container
    include_tasks: tasks/setup-redis.yml
    when: QUAY_REDIS_CONTAINERIZE

- hosts: quay
  tasks:

  - name: Deploy docker to quay container host
    include_tasks: tasks/setup-docker.yml
    vars:
      docker_packages:
        - docker
        - python-docker-py

  - name: Configure firewall
    include_tasks: tasks/firewall-setup.yml
    vars:
      ports:
        - 443/tcp
        - 80/tcp
        - 8443/tcp

  - name: Deploy quay config container
    include_tasks: tasks/quay-config-mode.yml
    when: QUAY_CONFIG

  - name: Deploy quay container
    include_tasks: tasks/deploy-quay.yml
    when: not QUAY_CONFIG

  - name: Deploy quay mirror sync container
    include_tasks: tasks/quay-mirror.yml
    when: not QUAY_CONFIG
