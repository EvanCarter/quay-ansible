---

  - name: Ensure that quay config is stopped
    docker_container:
      name: quay-config
      state: stopped
    tags:
      - deploy-quay

  - name: "Create quay config directory"
    file:
      state: directory
      path: /mnt/quay/config 
    tags:
      - deploy-quay
  
  - name: "Create quay storage directory (when object storage is not available)"
    file:
      state: directory
      path: /mnt/quay/storage
    when: not QUAY_OBJECT_STORAGE 
    tags:
      - deploy-quay

  - name: Copy the tarball to the quay host
    unarchive:
      src: "{{ QUAY_CONFIG_TAR }}"
      dest: /mnt/quay/config/
      copy: yes
    tags:
      - deploy-quay

  - name: Start quay
    docker_container:
      detach: yes
      restart: yes
      name: "quay"
      privileged: yes
      sysctls: { net.core.somaxconn: 4096 }
      published_ports: 
        - "{{ QUAY_HTTP_PORT }}:8080"
        - "{{ QUAY_HTTPS_PORT }}:8443"
      image: "quay.io/redhat/quay:v3.1.3"
      volumes:
        - /mnt/quay/config:/conf/stack:Z
        - /mnt/quay/storage:/datastorage:Z
    tags:
      - deploy-quay 